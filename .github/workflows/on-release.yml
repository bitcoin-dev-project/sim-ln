name: Release Binary

on:
  release:
    types: [created]

permissions:
  contents: write

env:
  DOCKER_IMAGE: scalingln/simln

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: taiki-e/create-gh-release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
  upload-assets:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: taiki-e/upload-rust-binary-action@v1
        with:
          # (required) Comma-separated list of binary names (non-extension portion of filename) to build and upload.
          # Note that glob pattern is not supported yet.
          bin: simln
          # (required) GitHub token for uploading assets to GitHub Releases.
          token: ${{ secrets.GITHUB_TOKEN }}
  publish-docker-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: olegtarasov/get-tag@v2.1.2
        name: Get tag
        id: tagName
        with:
          tagRegex: v?(.+) # Optional. Returns specified group text as tag name. Full tag string is returned if regex is not defined.
          tagRegexGroup: 1 # Optional. Default is 1.
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Docker tag and push latest
        run: |
          docker pull ${{env.DOCKER_IMAGE}}:${{ steps.tagName.outputs.tag }}
          docker tag ${{env.DOCKER_IMAGE}}:${{ steps.tagName.outputs.tag }} ${{env.DOCKER_IMAGE}}:latest
          docker push ${{env.DOCKER_IMAGE}}:latest
